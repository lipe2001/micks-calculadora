<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vendas</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <main class="container">
    <header class="brand card sales-header">
      <div>
        <h1 class="page-title"><i class="bi bi-graph-up-arrow"></i> Vendas registradas</h1>
        <p class="subtitle">Visualize, filtre e exporte as contratações em um único painel.</p>
      </div>
      <div class="sales-actions">
        <a class="btn-ghost" href="/vendas/export.xlsx?name={{ name }}&sort_by={{ sort_by }}"><i class="bi bi-file-earmark-excel-fill"></i> Exportar .xlsx</a>
        <form method="post" action="/logout"><button type="submit"><i class="bi bi-box-arrow-right"></i> Sair</button></form>
      </div>
    </header>

    <form class="card sales-filter" method="get" action="/vendas">
      <div class="grid sales-grid">
        <label><span class="icon-label"><i class="bi bi-search"></i> Filtrar por cliente</span><input type="text" name="name" value="{{ name }}" placeholder="Ex.: Maria" /></label>
        <label><span class="icon-label"><i class="bi bi-sort-down"></i> Ordenar por</span>
          <select name="sort_by">
            <option value="date" {% if sort_by == 'date' %}selected{% endif %}>Data</option>
            <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Nome</option>
          </select>
        </label>
        <div class="filter-submit">
          <button type="submit"><i class="bi bi-funnel-fill"></i> Aplicar filtros</button>
        </div>
      </div>
    </form>

    {% if notice %}<p class="feedback ok">{{ notice }}</p>{% endif %}
    {% if error %}<p class="error-text">Erro ao carregar vendas: {{ error }}</p>{% endif %}

    <div class="table-wrap card sales-table-card">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Cliente</th>
            <th>Contato</th>
            <th>Dispositivos</th>
            <th>Peso total</th>
            <th>Plano</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for sale in sales %}
          <tr>
            <td>{{ sale.created_at }}</td>
            <td>
              <strong>{{ sale.name }}</strong><br />
              <span class="muted">{{ sale.email }}</span>
            </td>
            <td>{{ sale.phone }}</td>
            <td>
              <div class="device-pills">
                {% for key, label in device_labels.items() %}
                <span class="pill">{{ label }}: <strong>{{ sale.devices.get(key, 0) }}</strong></span>
                {% endfor %}
              </div>
            </td>
            <td><span class="weight-badge">{{ '%.2f'|format(sale.total_weight) }}</span></td>
            <td>
              <strong>{{ sale.plan_name }}</strong><br />
              <span class="muted">{{ sale.plan_speed }}</span>
            </td>
            <td>
              <div class="row-actions">
                <a class="btn-ghost btn-small" href="/vendas/{{ sale.id }}/editar"><i class="bi bi-pencil-square"></i> Editar</a>
                <form method="post" action="/vendas/{{ sale.id }}/excluir" onsubmit="return confirm('Deseja realmente excluir esta venda?');">
                  <button type="submit" class="btn-danger btn-small"><i class="bi bi-trash"></i> Excluir</button>
                </form>
              </div>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="7">Nenhuma venda encontrada.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </main>
</body>
</html>
